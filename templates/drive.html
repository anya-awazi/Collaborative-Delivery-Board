{% extends "base.html" %}
{% block body %}
<h2>My Drive</h2>
<div>
  <strong>Storage used:</strong> <span id="storageUsed">...</span>
</div>
<div style="margin-top:10px">
  <input type="file" id="fileInput"> <button id="uploadBtn" class="btn">Upload</button>
  <select id="replication"><option value="2">Replication 2</option><option value="3">Replication 3</option></select>
</div>

<table id="files" style="width:100%;margin-top:12px;border-collapse:collapse">
  <thead><tr><th>File</th><th>Size</th><th>Status</th><th>Actions</th></tr></thead>
  <tbody></tbody>
</table>

<script>
async function refreshFiles(){
  const res = await fetch('/api/files');
  if(res.status!==200){ document.querySelector('#files tbody').innerHTML='<tr><td colspan="4">Auth required</td></tr>'; return; }
  const j = await res.json();
  document.getElementById('storageUsed').textContent = (j.used/1024/1024).toFixed(2) + ' MB of ' + (j.allowed/1024/1024).toFixed(2) + ' MB';
  const tbody = document.querySelector('#files tbody'); tbody.innerHTML='';
  j.files.forEach(f=>{
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>${f.file_name}</td><td>${(f.size/1024).toFixed(2)} KB</td><td id="s-${f.network_id}">Checking...</td>
      <td>
        <button onclick="download('${f.network_id}')" class="btn">Download</button>
        <button onclick="del('${f.network_id}')" style="background:#c62828" class="btn">Delete</button>
      </td>`;
    tbody.appendChild(tr);
    // check status
    (async ()=>{
      const st = await fetch('/api/file_status/'+f.network_id).then(r=>r.json());
      document.getElementById('s-'+f.network_id).textContent = st.status + (st.chunks_done? ` (${st.chunks_done}/${st.chunks_total})`:'');
    })();
  });
}

document.getElementById('uploadBtn').addEventListener('click', async ()=>{
  const input=document.getElementById('fileInput'); if(!input.files.length) return alert('choose file');
  const file = input.files[0]; const form = new FormData();
  form.append('file', file); form.append('replication', document.getElementById('replication').value);
  const res = await fetch('/api/upload', {method:'POST', body: form});
  const j = await res.json();
  if(j.error){ alert('Error: '+j.error); return; }
  alert('Upload initiated: '+j.file_id);
  setTimeout(refreshFiles, 1000);
});

async function download(id){ location.href='/api/download/'+id; }
async function del(id){ if(!confirm('Delete?')) return; await fetch('/api/delete/'+id,{method:'POST'}); refreshFiles(); }

refreshFiles();
setInterval(refreshFiles, 5000);
</script>
{% endblock %}
